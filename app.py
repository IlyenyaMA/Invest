import pandas as pd
import streamlit as st
from tinkoff.invest import Client, CandleInterval
from datetime import datetime, timedelta, timezone

# ===================
# –ù–ê–°–¢–†–û–ô–ö–ò
TOKEN = "t.a_yTo2QKdKX0FFwrNTmkvlKAfBml74hg7SVdW-GbyAVhY5znKubj2meA61ufoYGu_awUxQvozh07QHBrY3OgZA"

INSTRUMENTS = {
    "–ë–∞—à–Ω–µ—Ñ—Ç—å": "BBG004S68758",
    "–¢—Ä—É–±–Ω–∞—è –ú–µ—Ç–∞–ª–ª—É—Ä–≥–∏—á–µ—Å–∫–∞—è –ö–æ–º–ø–∞–Ω–∏—è": "BBG004TC84Z8",
    "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –ë–∏—Ä–∂–∞": "BBG004730JJ5",
    "–ë–∞—à–Ω–µ—Ñ—Ç—å ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏": "BBG004S686N0",
    "–†–£–°–ê–õ": "BBG008F2T3T2",
    "–¢–∞—Ç—Ç–µ–ª–µ–∫–æ–º": "BBG000RJL816",
    "–ú–†–°–ö –£—Ä–∞–ª–∞": "BBG000VKG4R5",
    "–ù–æ—Ä–∏–ª—å—Å–∫–∏–π –Ω–∏–∫–µ–ª—å": "BBG004731489",
    "–ú–†–°–ö –°–µ–≤–µ—Ä–æ-–ó–∞–ø–∞–¥–∞": "BBG000TJ6F42",
    "–¢–ì–ö-2": "BBG000Q7GG57",
    "–ü–ê–û ¬´–ö–ê–ó–ê–ù–¨–û–†–ì–°–ò–ù–¢–ï–ó¬ª": "BBG0029SFXB3",
    "–ú–û–≠–°–ö": "BBG004S687G6",
    "QIWI": "BBG005D1WCQ1",
    "–ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è –ò–†–ö–£–¢": "BBG000FWGSZ5",
    "–Æ–Ω–∏–ø—Ä–æ": "BBG004S686W0",
    "–ú–µ—á–µ–ª ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏": "BBG004S68FR6",
    "–ü–ê–û ¬´–ö–ê–ó–ê–ù–¨–û–†–ì–°–ò–ù–¢–ï–ó¬ª ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG0029SG1C1",
    "–õ–µ–Ω—ç–Ω–µ—Ä–≥–æ": "BBG000NLC9Z6",
    "–†—É—Å–ì–∏–¥—Ä–æ": "BBG00475K2X9",
    "–†–æ—Å—Ç–µ–ª–µ–∫–æ–º ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏": "BBG004S685M3",
    "Yandex": "TCS00A107T19",
    "–ê–§–ö –°–∏—Å—Ç–µ–º–∞": "BBG004S68614",
    "–¢–ù–° —ç–Ω–µ—Ä–≥–æ –í–æ—Ä–æ–Ω–µ–∂": "BBG000BX7DH0",
    "–ë–∞–Ω–∫ –í–¢–ë": "BBG004730ZJ9",
    "–†–æ—Å–Ω–µ—Ñ—Ç—å": "BBG004731354",
    "–ù–∏–∂–Ω–µ–∫–∞–º—Å–∫–Ω–µ—Ñ—Ç–µ—Ö–∏–º": "BBG000GQSRR5",
    "En+ Group": "BBG000RMWQD4",
    "–ß–ú–ö": "BBG000RP8V70",
    "–§–°–ö –ï–≠–°": "BBG00475JZZ6",
    "–ì–∞–∑–ø—Ä–æ–º": "BBG004730RP0",
    "–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∏–π –ù–ü–ó ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG002B2J5X0",
    "–†–∞—Å–ø–∞–¥—Å–∫–∞—è": "BBG004S68696",
    "–ê–ø—Ç–µ—á–Ω–∞—è —Å–µ—Ç—å 36,6": "BBG000K3STR7",
    "–°–µ–≤–µ—Ä—Å—Ç–∞–ª—å": "BBG00475K6C3",
    "–°–±–µ—Ä–±–∞–Ω–∫ –†–æ—Å—Å–∏–∏ ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏": "BBG0047315Y7",
    "–ú–†–°–ö –í–æ–ª–≥–∏": "BBG000PKWCQ7",
    "–ê–õ–†–û–°–ê": "BBG004S68B31",
    "–°–µ–ª–∏–≥–¥–∞—Ä": "BBG002458LF8",
    "–ì—Ä—É–ø–ø–∞ –ß–µ—Ä–∫–∏–∑–æ–≤–æ": "BBG000RTHVK7",
    "–†—É—Å—Å–∫–∞—è –∞–∫–≤–∞–∫—É–ª—å—Ç—É—Ä–∞": "BBG000W325F7",
    "–ú–æ—Å—ç–Ω–µ—Ä–≥–æ": "BBG004S687W8",
    "–¢–∞—Ç–Ω–µ—Ñ—Ç—å ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏": "BBG004S68829",
    "–°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑": "BBG0047315D0",
    "–ö–∞–ª—É–∂—Å–∫–∞—è —Å–±—ã—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è": "BBG000DBD6F6",
    "–¢–ì–ö-1": "BBG000QFH687",
    "–†—É—Å—Å–ù–µ—Ñ—Ç—å": "BBG00F9XX7H4",
    "–°–ê–§–ú–ê–†": "BBG003LYCMB1",
    "–ê–∫—Ä–æ–Ω": "BBG004S688G4",
    "–ú–∞–≥–Ω–∏—Ç": "BBG004RVFCY3",
    "–†—É—Å–ê–≥—Ä–æ": "TCS90A0JQUZ6",
    "–ö–ê–ú–ê–ó": "BBG000LNHHJ9",
    "–õ–µ–Ω–∑–æ–ª–æ—Ç–æ": "BBG000SK7JS5",
    "–í—Ç–æ—Ä–∞—è –≥–µ–Ω–µ—Ä–∏—Ä—É—é—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è –æ–ø—Ç–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏": "BBG000RK52V1",
    "–ú–†–°–ö –¶–µ–Ω—Ç—Ä–∞ –∏ –ü—Ä–∏–≤–æ–ª–∂—å—è": "BBG000VG1034",
    "–õ–£–ö–û–ô–õ": "BBG004731032",
    "–ü–æ–ª—é—Å –ó–æ–ª–æ—Ç–æ": "BBG000R607Y3",
    "–ë–∞–Ω–∫ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥": "BBG000QJW156",
    "–¢–∞—Ç–Ω–µ—Ñ—Ç—å": "BBG004RVFFC0",
    "–Æ–£–ù–ö": "BBG002YFXL29",
    "–ü–µ—Ä–º—ç–Ω–µ—Ä–≥–æ—Å–±—ã—Ç ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG000MZL2S9",
    "–†–æ—Å—Ç–µ–ª–µ–∫–æ–º": "BBG004S682Z6",
    "TCS Group": "TCS80A107UL4",
    "–í–°–ú–ü–û-–ê–í–ò–°–ú–ê": "BBG004S68CV8",
    "–ú–ì–¢–° ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG000PZ0833",
    "–ú.–≤–∏–¥–µ–æ": "BBG004S68CP5",
    "–°–±–µ—Ä–±–∞–Ω–∫ –†–æ—Å—Å–∏–∏": "BBG004730N88",
    "–†—É—Å–æ–ª–æ–≤–æ": "BBG004Z2RGW8",
    "–ü–ò–ö": "BBG004S68BH6",
    "–§–æ—Å–ê–≥—Ä–æ": "BBG004S689R0",
    "–ù–õ–ú–ö": "BBG004S681B4",
    "–°–û–õ–õ–ï–†–°": "BBG004S68JR8",
    "–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –∞–≤–∏–∞—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏—è": "BBG000Q7ZZY2",
    "–¢–ì–ö-14": "BBG000RG4ZQ4",
    "–¢—Ä–∞–Ω—Å–Ω–µ—Ñ—Ç—å": "BBG00475KHX6",
    "–ú–¢–°": "BBG004S681W1",
    "–ö—Ä–∞—Å–Ω—ã–π –û–∫—Ç—è–±—Ä—å": "BBG000NLB2G3",
    "–ì—Ä—É–ø–ø–∞ –õ–°–†": "BBG004S68C39",
    "–°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑ ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏": "BBG004S681M2",
    "–ù–ú–¢–ü": "BBG004S68BR5",
    "–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫–∏–π –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—á–µ—Å–∫–∏–π –∫–æ–º–±–∏–Ω–∞—Ç": "BBG004S68507",
    "–õ–µ–Ω—ç–Ω–µ—Ä–≥–æ ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG000NLCCM3",
    "–ì–∞–∑–ø—Ä–æ–º –Ω–µ—Ñ—Ç—å": "BBG004S684M6",
    "–ù–∏–∂–Ω–µ–∫–∞–º—Å–∫–Ω–µ—Ñ—Ç–µ—Ö–∏–º ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG000GQSVC2",
    "–î–≠–ö": "BBG000V07CB8",
    "–ù–∞—É–∫–∞-–°–≤—è–∑—å": "BBG002BCQK67",
    "–¢–ì–ö-2 ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG000Q7GJ60",
    "–ù–û–í–ê–¢–≠–ö": "BBG00475KKY8",
    "–ú–µ—á–µ–ª": "BBG004S68598",
    "–†–ö–ö –≠–Ω–µ—Ä–≥–∏—è –∏–º.–°.–ü.–ö–æ—Ä–æ–ª–µ–≤–∞": "BBG000LWNRP3",
    "–õ–µ–Ω—Ç–∞": "BBG0063FKTD9",
    "–ú–†–°–ö –°–∏–±–∏—Ä–∏": "BBG000VJMH65",
    "–ú–†–°–ö –Æ–≥–∞": "BBG000C7P5M7",
    "–û–í–ö": "TCS90A0JVBT9",
    "–ü–µ—Ä–º—ç–Ω–µ—Ä–≥–æ—Å–±—ã—Ç": "BBG000MZL0Y6",
    "–ë–µ–ª—É–≥–∞ –ì—Ä—É–ø–ø –ü–ê–û –∞–æ": "BBG000TY1CD1",
    "–î–í–ú–ü": "BBG000QF1Q17",
    "–ú–ö–ë": "BBG009GSYN76",
    "–ú–æ—Å—Ç–æ—Ç—Ä–µ—Å—Ç": "BBG004S68DD6",
    "–ù–ö–•–ü": "BBG00BGKYH17",
    "–ú–†–°–ö –¶–µ–Ω—Ç—Ä–∞": "BBG000VH7TZ8",
    "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –¢–µ–ª–µ–≥—Ä–∞—Ñ ‚Äî –∞–∫—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": "BBG0027F0Y27",
    "–ò–Ω—Ç–µ—Ä –†–ê–û –ï–≠–°": "BBG004S68473",
    "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –¢–µ–ª–µ–≥—Ä–∞—Ñ": "BBG000BBV4M5",
    "–ê—ç—Ä–æ—Ñ–ª–æ—Ç": "BBG004S683W7",
    "–ì–î–† X5 RetailGroup": "TCS03A108X38",
    "–ê–±—Ä–∞—É–î—é—Ä—Å–æ": "BBG002W2FT69",
    "–§–æ–Ω–¥ –∫—Ä—É–ø–Ω–µ–π—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –†–§": "TCS60A101X76",
    "–§–æ–Ω–¥ –∑–æ–ª–æ—Ç–æ": "IE00B8XB7377",
    "–§–æ–Ω–¥ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏": "TCS70A10A1L8",
    "–§–æ–Ω–¥ –†–æ—Å—Å–∏–π—Å–∫–∏–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏": "TCS60A1039N1",
    "–§–æ–Ω–¥ –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥": "TCS00A108WX3",
    "–§–æ–Ω–¥ –≤–µ—á–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å": "BBG000000001",
    "–§–æ–Ω–¥ –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤–∞–ª—é—Ç–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏": "TCS20A107597",
    "–†–µ–Ω–µ—Å—Å–∞–Ω—Å": "BBG00QKJSX05",
    "–ì–ö –°–∞–º–æ–ª—ë—Ç": "BBG00F6NKQX3",
    "–Æ–∂—É—Ä–∞–ª–∑–æ–ª–æ—Ç–æ –ì–ö": "TCS00A0JPP37",
    "–î–µ–ª–∏–º–æ–±–∏–ª—å": "TCS00A107J11",
    "–í–ö": "TCS00A106YF0",
    "–¶–∏–∞–Ω": "TCS00A10ANA1",
    "–ö—É–π–±—ã—à–µ–≤ –ê–∑–æ—Ç": "BBG002B9MYC1",
    "–°–µ–≥–µ–∂–∞": "BBG0100R9963",
    "–≠–ª–µ–º–µ–Ω—Ç": "TCS50A102093",
    "–§–°–ö –†–æ—Å—Å–µ—Ç–∏": "BBG00475JZZ6",
    "–†–ë–ö": "TCS10A0JR6A6",
    "–°–æ–≤–∫–æ–º—Ñ–ª–æ—Ç": "BBG000R04X57",
    "–ï–≤—Ä–æ–ø–ª–∞–Ω": "TCS00A0ZZFS9",
    "–°–ü–ë –±–∏—Ä–∂–∞": "TCS60A0JQ9P9",
    "–≠—Ç–∞–ª–æ–Ω –≥—Ä—É–ø–ø": "TCS50A10C1L6",
    "–ë–µ–ª–æ–Ω": "TCS20A0J2QG8",
    "–ù–æ–≤–∞–±–µ–≤": "BBG000TY1CD1",
    "HENDERSON": "TCS00A106XF2",
    "–†–æ—Å—Å–µ—Ç–∏ —Ü–µ–Ω—Ç—Ä": "BBG000VH7TZ8",
    "–°–æ–≤–∫–æ–º–±–∞–Ω–∫": "TCS00A0ZZAC4",
    "–ì–¢–ú": "TCS03A0ZYD22",
    "–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã": "TCS10A108K09",
    "–ú–¢–° –ë–∞–Ω–∫": "TCS00A0JRH43",
    "–ò–ù–ê–†–ö–¢–ò–ö–ê": "BBG000W325F7",
    "–ö–∞—Ä–ú–∞–Ω–∏": "TCS00A105NV2",
    "–ö—Ä–∏—Å—Ç–∞–ª–ª": "TCS00A107KX0",
    "OZON": "BBG00Y91R9T3",
    "–ó–∞–≤–æ–¥ –î–ò–û–î": "BBG000G25P51",
    "–ê–°–¢–†–ê": "RU000A106T36",
    "–ê–ø—Ç–µ–∫–∏": "BBG000K3STR7",
    "–§–∞—Ä–º—Å–∏–Ω—Ç–µ–∑": "TCS10A0JR514",
    "–Ø–¢–≠–ö": "BBG002B298N6",
    "–≠–õ-5 —ç–Ω–µ—Ä–≥–æ": "BBG000F6YPH8",
    "–ú–ì–ö–õ": "TCS00A0JVJQ8",
    "–ú–∞—Ç—å –∏ –¥–∏—Ç—è": "TCS00Y3XYV94",
    "–•—ç–¥—Ö–∞–Ω—Ç–µ—Ä": "TCS20A107662",
    "–û–∑–æ–Ω —Ñ–∞—Ä–º–∞": "TCS00A109B25"
}

TIMEFRAMES = {
    "5m": CandleInterval.CANDLE_INTERVAL_5_MIN,
    "1h": CandleInterval.CANDLE_INTERVAL_HOUR,
    "1d": CandleInterval.CANDLE_INTERVAL_DAY,
}

# ===================
def get_days_for_interval(tf_name):
    if tf_name == "5m":
        return 7
    elif tf_name == "1h":
        return 60
    elif tf_name == "1d":
        return 365
    return 30

def rsi(series, period=14):
    delta = series.diff()
    up = delta.clip(lower=0)
    down = -delta.clip(upper=0)
    roll_up = up.ewm(alpha=1/period, adjust=False).mean()
    roll_down = down.ewm(alpha=1/period, adjust=False).mean()
    rs = roll_up / roll_down
    return 100 - (100 / (1 + rs))

def get_rsi(client, figi, tf_name, interval):
    days = get_days_for_interval(tf_name)
    now = datetime.now(timezone.utc)
    start = now - timedelta(days=days)

    try:
        candles = client.market_data.get_candles(
            figi=figi,
            from_=start,
            to=now,
            interval=interval
        ).candles
    except Exception:
        return None, None

    if not candles or len(candles) < 15:
        return None, None

    closes = [c.close.units + c.close.nano / 1e9 for c in candles]

    # –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–µ–Ω—É
    try:
        last_price_resp = client.market_data.get_last_prices(figi=[figi])
        if last_price_resp.last_prices:
            current_price = (
                last_price_resp.last_prices[0].price.units
                + last_price_resp.last_prices[0].price.nano / 1e9
            )
            closes[-1] = current_price
    except:
        pass

    rsi_val = round(rsi(pd.Series(closes)).iloc[-1], 2)
    last_time = candles[-1].time.astimezone(
        timezone(timedelta(hours=3))
    ).strftime("%Y-%m-%d %H:%M:%S")

    return rsi_val, last_time

# ===================
# Streamlit UI
st.title("üìä RSI –º–æ–Ω–∏—Ç–æ—Ä –¥–ª—è –∞–∫—Ü–∏–π –ú–æ—Å–±–∏—Ä–∂–∏")

tf_choice = st.selectbox("–í—ã–±–µ—Ä–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º", list(TIMEFRAMES.keys()), index=1)

if st.button("üîç –ü–æ—Å—á–∏—Ç–∞—Ç—å RSI"):
    results = {}
    with Client(TOKEN) as client:
        for name, figi in INSTRUMENTS.items():
            val, last_time = get_rsi(client, figi, tf_choice, TIMEFRAMES[tf_choice])
            if val is not None:
                results[name] = {"RSI": val, "–í—Ä–µ–º—è": last_time}
            else:
                results[name] = {"RSI": None, "–í—Ä–µ–º—è": "-"}

    df = pd.DataFrame(results).T
    df_sorted = df.sort_values(by="RSI", ascending=True)

    # –ø–æ–¥—Å–≤–µ—Ç–∫–∞ RSI
    def color_rsi(val):
        if pd.isna(val):
            return ""
        if val < 30:
            return "background-color: lightgreen"
        elif val > 70:
            return "background-color: lightcoral"
        return ""

    st.dataframe(df_sorted.style.applymap(color_rsi, subset=["RSI"]))
