<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>RSI Таблица</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 10px; }
  h1 { text-align: center; margin-bottom: 10px; }

  .bar { display:flex; flex-wrap: wrap; gap:12px; align-items:center; justify-content:space-between; max-width:100%; margin:0 auto 10px auto; }
  .bar .left { display:flex; flex-wrap: wrap; gap:12px; align-items:center; }
  button { padding: 8px 12px; border:0; border-radius:8px; background:#4CAF50; color:#fff; cursor:pointer; }
  button:hover { filter: brightness(0.95); }

  .table-wrapper { overflow-x: auto; width: 100%; }
  table { width: 100%; min-width: 700px; border-collapse: collapse; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
  th { background-color: #4CAF50; color: white; cursor: pointer; user-select: none; }
  tr:nth-child(even) { background-color: #f9f9f9; }
  tr:hover { background-color: #f1f1f1; }
  .th-sort::after { content: " ⇅"; font-size: 12px; opacity: .85; }
  .th-sort.asc::after { content: " ↑"; }
  .th-sort.desc::after { content: " ↓"; }
</style>
</head>
<body>

<h1>RSI Таблица</h1>
<div class="bar">
  <div class="left">
    <button id="refreshBtn">Обновить данные</button>
    <span id="status"></span>
  </div>
  <small>Нажми на заголовок «5 минут» или «1 час» для сортировки</small>
</div>

<div class="table-wrapper">
  <table id="rsiTable">
    <thead>
      <tr>
        <th>Инструмент</th>
        <th id="th-5m" class="th-sort" data-tf="5m">5 минут</th>
        <th id="th-1h" class="th-sort" data-tf="1h">1 час</th>
        <th>Время последней свечи</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let lastData = {};
let sortState = { tf: null, dir: 'desc' };

async function fetchRSI() {
  const status = document.getElementById('status');
  try {
    status.textContent = 'Загрузка...';
    const res = await fetch('/api/rsi', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    lastData = await res.json();
    status.textContent = 'Обновлено: ' + new Date().toLocaleTimeString();
    renderTableChunked();
  } catch (e) {
    console.error('Ошибка загрузки данных:', e);
    status.textContent = 'Ошибка загрузки';
  }
}

// Chunked rendering для больших таблиц
function renderTableChunked() {
  const tbody = document.querySelector('#rsiTable tbody');
  tbody.innerHTML = '';
  let names = Object.keys(lastData);

  // сортировка
  if (sortState.tf) {
    const tf = sortState.tf;
    const dir = sortState.dir === 'asc' ? 1 : -1;
    names.sort((a, b) => {
      const va = lastData[a][tf]?.RSI ?? -Infinity;
      const vb = lastData[b][tf]?.RSI ?? -Infinity;
      if (va === vb) return a.localeCompare(b);
      return (va - vb) * dir;
    });
  }

  let i = 0;
  function addChunk() {
    const chunkSize = 20;
    for (let j = 0; j < chunkSize && i < names.length; j++, i++) {
      const name = names[i];
      const r5 = lastData[name]['5m']?.RSI ?? '-';
      const r1 = lastData[name]['1h']?.RSI ?? '-';
      const t5 = lastData[name]['5m']?.time ?? '-';
      const t1 = lastData[name]['1h']?.time ?? '-';
      const lastTime = t5 !== '-' ? t5 : t1;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${r5}</td><td>${r1}</td><td>${lastTime}</td>`;
      tbody.appendChild(tr);
    }
    if (i < names.length) requestAnimationFrame(addChunk);
  }
  addChunk();

  // визуальные индикаторы сортировки
  document.querySelectorAll('.th-sort').forEach(th => th.classList.remove('asc', 'desc'));
  if (sortState.tf) {
    const th = document.querySelector(`.th-sort[data-tf="${sortState.tf}"]`);
    if (th) th.classList.add(sortState.dir);
  }
}

// сортировка
document.getElementById('th-5m').addEventListener('click', () => toggleSort('5m'));
document.getElementById('th-1h').addEventListener('click', () => toggleSort('1h'));
function toggleSort(tf) {
  if (sortState.tf === tf) sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
  else { sortState.tf = tf; sortState.dir = 'desc'; }
  renderTableChunked();
}

// кнопка обновления
document.getElementById('refreshBtn').addEventListener('click', fetchRSI);

// автообновление каждые 60 секунд
setInterval(fetchRSI, 60*1000);

// первый запуск
fetchRSI();
</script>
</body>
</html>
