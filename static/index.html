<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RSI Таблица</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f0f2f5; }
  h1 { text-align:center; }
  .bar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
  button { padding:6px 12px; border:none; border-radius:6px; background:#4CAF50; color:#fff; cursor:pointer; }
  button:hover { filter:brightness(0.9); }
  table { width:100%; border-collapse: collapse; margin-top:10px; overflow-x:auto; display:block; }
  th, td { padding:8px; border:1px solid #ddd; text-align:center; white-space: nowrap; }
  th { background:#4CAF50; color:white; cursor:pointer; }
  tr:nth-child(even){background:#f9f9f9;}
  tr:hover {background:#f1f1f1;}
  .th-sort::after { content:" ⇅"; font-size:10px; opacity:.7; }
  .th-sort.asc::after { content:" ↑"; }
  .th-sort.desc::after { content:" ↓"; }
</style>
</head>
<body>

<h1>RSI Таблица</h1>
<div class="bar">
  <button id="refreshBtn">Обновить данные</button>
  <span id="status">Загрузка...</span>
</div>

<table id="rsiTable">
  <thead>
    <tr>
      <th>Инструмент</th>
      <th id="th-5m" class="th-sort" data-tf="5m">5 минут</th>
      <th id="th-1h" class="th-sort" data-tf="1h">1 час</th>
      <th>Время последней свечи</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let lastData = {};
let sortState = { tf: null, dir: 'desc' };

async function fetchRSI(){
  const status = document.getElementById('status');
  try {
    status.textContent = 'Загрузка...';
    const res = await fetch('/api/rsi', {cache:'no-store'});
    lastData = await res.json();
    status.textContent = 'Обновлено: ' + new Date().toLocaleTimeString();
    renderTable();
  } catch(e){
    console.error(e);
    status.textContent = 'Ошибка загрузки';
  }
}

function renderTable(){
  const tbody = document.querySelector('#rsiTable tbody');
  tbody.innerHTML = '';

  let names = Object.keys(lastData);
  if(sortState.tf){
    const tf = sortState.tf, dir = sortState.dir==='asc'?1:-1;
    names.sort((a,b)=>{
      const va = lastData[a][tf]?.RSI??'-';
      const vb = lastData[b][tf]?.RSI??'-';
      const na = va==='-'?-Infinity:Number(va);
      const nb = vb==='-'?-Infinity:Number(vb);
      if(na===nb) return a.localeCompare(b);
      return (na-nb)*dir;
    });
  }

  for(const name of names){
    const r5 = lastData[name]['5m']?.RSI??'-';
    const r1 = lastData[name]['1h']?.RSI??'-';
    const t5 = lastData[name]['5m']?.time??'-';
    const t1 = lastData[name]['1h']?.time??'-';
    const lastTime = t5!=='-'?t5:t1;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${r5}</td><td>${r1}</td><td>${lastTime}</td>`;
    tbody.appendChild(tr);
  }

  document.querySelectorAll('.th-sort').forEach(th=>th.classList.remove('asc','desc'));
  if(sortState.tf){
    const th = document.querySelector(`.th-sort[data-tf="${sortState.tf}"]`);
    if(th) th.classList.add(sortState.dir);
  }
}

document.getElementById('th-5m').addEventListener('click', ()=>toggleSort('5m'));
document.getElementById('th-1h').addEventListener('click', ()=>toggleSort('1h'));
function toggleSort(tf){
  if(sortState.tf===tf) sortState.dir = sortState.dir==='asc'?'desc':'asc';
  else {sortState.tf=tf; sortState.dir='desc';}
  renderTable();
}

document.getElementById('refreshBtn').addEventListener('click', fetchRSI);
setInterval(fetchRSI, 60*1000); // автообновление каждые 1 мин
fetchRSI();
</script>

</body>
</html>
