<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSI Таблица</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 2vh 2vw; margin:0; }
    h1 { text-align: center; font-size: 4vw; margin-bottom: 1vh; }
    .bar { display:flex; flex-wrap: wrap; gap:2vw; align-items:center; justify-content: space-between; margin-bottom:1vh; }
    .bar .left { display:flex; gap:1vw; flex-wrap: wrap; align-items:center; }
    button { padding: 0.5vh 1vw; border:0; border-radius:0.5vh; background:#4CAF50; color:#fff; cursor:pointer; font-size:3vw; }
    button:hover { filter: brightness(0.95); }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 0 1vh rgba(0,0,0,0.1); display:block; max-height: 80vh; overflow-y: auto; }
    thead { display: table; width: 100%; table-layout: fixed; }
    tbody { display: block; width: 100%; }
    tr { display: table; width: 100%; table-layout: fixed; }
    th, td { padding: 1vh 1vw; border: 1px solid #ddd; text-align: center; font-size: 3vw; word-wrap: break-word; }
    th { background-color: #4CAF50; color: white; cursor: pointer; user-select: none; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }
    .th-sort::after { content: " ⇅"; font-size: 2vw; opacity: .85; }
    .th-sort.asc::after { content: " ↑"; }
    .th-sort.desc::after { content: " ↓"; }
    @media (min-width: 768px) {
      h1 { font-size: 2vw; }
      button { font-size: 1.2vw; }
      th, td { font-size: 1vw; padding: 0.5vh 0.5vw; }
      .th-sort::after { font-size: 0.8vw; }
    }
  </style>
</head>
<body>

<h1>RSI Таблица</h1>
<div class="bar">
  <div class="left">
    <button id="refreshBtn">Обновить данные</button>
    <span id="status"></span>
  </div>
  <small>Нажми на заголовок «5 минут» или «1 час» для сортировки</small>
</div>

<table id="rsiTable">
  <thead>
    <tr>
      <th>Инструмент</th>
      <th id="th-5m" class="th-sort" data-tf="5m">5 минут</th>
      <th id="th-1h" class="th-sort" data-tf="1h">1 час</th>
      <th>Время последней свечи</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let lastData = {};
let sortState = { tf: null, dir: 'desc' };

async function fetchRSI() {
  const status = document.getElementById('status');
  try {
    status.textContent = 'Загрузка...';
    const res = await fetch('/api/rsi', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    lastData = await res.json();
    status.textContent = 'Обновлено: ' + new Date().toLocaleTimeString();
    renderTable();
  } catch (e) {
    console.error('Ошибка загрузки данных:', e);
    status.textContent = 'Ошибка загрузки';
  }
}

function renderTable() {
  const tbody = document.querySelector('#rsiTable tbody');
  tbody.innerHTML = '';

  let names = Object.keys(lastData);

  if (sortState.tf) {
    const tf = sortState.tf;
    const dir = sortState.dir === 'asc' ? 1 : -1;
    names.sort((a, b) => {
      const va = lastData[a][tf]?.RSI;
      const vb = lastData[b][tf]?.RSI;
      const na = (va === '-' || va === null || va === undefined) ? -Infinity : Number(va);
      const nb = (vb === '-' || vb === null || vb === undefined) ? -Infinity : Number(vb);
      if (na === nb) return a.localeCompare(b);
      return (na - nb) * dir;
    });
  }

  let html = '';
  for (const name of names) {
    const r5 = lastData[name]['5m']?.RSI ?? '-';
    const r1 = lastData[name]['1h']?.RSI ?? '-';
    const t5 = lastData[name]['5m']?.time ?? '-';
    const t1 = lastData[name]['1h']?.time ?? '-';
    const lastTime = t5 !== '-' ? t5 : t1;

    // подсветка RSI
    const r5Style = (r5 !== '-' && !isNaN(r5)) ? (r5 < 30 ? 'background-color:green;color:white;' : r5 > 70 ? 'background-color:red;color:white;' : '') : '';
    const r1Style = (r1 !== '-' && !isNaN(r1)) ? (r1 < 30 ? 'background-color:green;color:white;' : r1 > 70 ? 'background-color:red;color:white;' : '') : '';

    html += `
      <tr>
        <td>${name}</td>
        <td style="${r5Style}">${r5}</td>
        <td style="${r1Style}">${r1}</td>
        <td>${lastTime}</td>
      </tr>`;
  }
  tbody.innerHTML = html;

  document.querySelectorAll('.th-sort').forEach(th => th.classList.remove('asc', 'desc'));
  if (sortState.tf) {
    const th = document.querySelector(`.th-sort[data-tf="${sortState.tf}"]`);
    if (th) th.classList.add(sortState.dir);
  }
}

document.getElementById('th-5m').addEventListener('click', () => toggleSort('5m'));
document.getElementById('th-1h').addEventListener('click', () => toggleSort('1h'));

function toggleSort(tf) {
  if (sortState.tf === tf) {
    sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
  } else {
    sortState.tf = tf;
    sortState.dir = 'desc';
  }
  renderTable();
}

document.getElementById('refreshBtn').addEventListener('click', fetchRSI);
setInterval(fetchRSI, 5 * 60 * 1000);
fetchRSI();
</script>
</body>
</html>
