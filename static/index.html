<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>RSI Таблица</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; cursor: pointer; }
    tr:hover { background: #fafafa; }
    .highlight { background-color: lightgreen; }
  </style>
</head>
<body>
  <h1>RSI14 Таблица</h1>
  <table id="rsiTable">
    <thead>
      <tr>
        <th>Инструмент</th>
        <th data-tf="5m">5m</th>
        <th data-tf="15m">15m</th>
        <th data-tf="1h">1h</th>
        <th data-tf="4h">4h</th>
        <th data-tf="1d">1d</th>
        <th data-tf="1w">1w</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // --- Конфигурация ---
    const TOKEN = TOKEN = "t.a_yTo2QKdKX0FFwrNTmkvlKAfBml74hg7SVdW-GbyAVhY5znKubj2meA61ufoYGu_awUxQvozh07QHBrY3OgZA"; // Токен Тинькофф
    const INSTRUMENTS = {
      "Сбербанк": "BBG004730N88",
      "Газпром": "BBG004730RP0",
      "Лукойл": "BBG004730ZJ9",
      "Яндекс": "BBG006L8G4H1",
      "Фонд крупнейшие компании РФ": "TCS00A102F40",
      "Фонд золото": "TCS00A100FQ8"
    };
    const TIMEFRAMES = ["5m", "15m", "1h", "4h", "1d", "1w"];
    const INTERVALS = {
      "5m": "CANDLE_INTERVAL_5_MIN",
      "15m": "CANDLE_INTERVAL_15_MIN",
      "1h": "CANDLE_INTERVAL_HOUR",
      "4h": "CANDLE_INTERVAL_4_HOUR",
      "1d": "CANDLE_INTERVAL_DAY",
      "1w": "CANDLE_INTERVAL_WEEK"
    };

    // --- RSI ---
    function rsi(values, period = 14) {
      if (values.length < period) return null;
      let gains = [], losses = [];
      for (let i = 1; i < values.length; i++) {
        const diff = values[i] - values[i-1];
        if (diff >= 0) gains.push(diff); else losses.push(-diff);
      }
      let avgGain = gains.reduce((a,b)=>a+b,0) / period;
      let avgLoss = losses.reduce((a,b)=>a+b,0) / period;
      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return +(100 - 100 / (1 + rs)).toFixed(2);
    }

    // --- Получение свечей ---
    async function fetchCandles(figi, interval, days = 30) {
      const now = new Date().toISOString();
      const from = new Date(Date.now() - days*24*60*60*1000).toISOString();
      const url = "https://invest-public-api.tinkoff.ru/rest/tinkoff.public.invest.api.contract.v1.MarketDataService/GetCandles";

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          figi,
          from,
          to: now,
          interval
        })
      });

      const data = await res.json();
      return data.candles || [];
    }

    // --- Построение таблицы ---
    async function buildTable() {
      const tbody = document.querySelector("#rsiTable tbody");
      tbody.innerHTML = "";

      for (const [name, figi] of Object.entries(INSTRUMENTS)) {
        const row = document.createElement("tr");
        const cellName = document.createElement("td");
        cellName.textContent = name;
        row.appendChild(cellName);

        for (const tf of TIMEFRAMES) {
          const cell = document.createElement("td");
          const candles = await fetchCandles(figi, INTERVALS[tf], 60);
          if (candles.length > 15) {
            const closes = candles.map(c => c.close?.units + c.close?.nano/1e9);
            const rsiVal = rsi(closes);
            if (rsiVal !== null) {
              cell.textContent = rsiVal;
              if (rsiVal < 30 || rsiVal > 70) cell.classList.add("highlight");
            } else {
              cell.textContent = "-";
            }
          } else {
            cell.textContent = "-";
          }
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      }
    }

    // --- Сортировка по столбцу ---
    document.querySelectorAll("th[data-tf]").forEach(th => {
      th.addEventListener("click", () => {
        const tfIndex = [...th.parentNode.children].indexOf(th);
        const tbody = document.querySelector("#rsiTable tbody");
        const rows = [...tbody.querySelectorAll("tr")];

        rows.sort((a,b) => {
          const aVal = parseFloat(a.children[tfIndex].textContent) || Infinity;
          const bVal = parseFloat(b.children[tfIndex].textContent) || Infinity;
          return aVal - bVal;
        });

        tbody.innerHTML = "";
        rows.forEach(r => tbody.appendChild(r));
      });
    });

    // --- Запуск ---
    buildTable();
  </script>
</body>
</html>
